# AGENTS.md

## Multi-AI Pair Work Framework（協働モデル）

このプロジェクトでは3つのAI CLIツールが協働してタスクに取り組む。

| 役割 | ツール | 得意領域 |
|---|---|---|
| **設計リード (Design Lead)** | Claude Code | 意図理解・設計判断・対話・タスク分解・統合・Git・MCP |
| **実装リード (Implementation Lead)** | Codex CLI | コード実装・テスト・修正・定型作業・CI/CD・コードレビュー |
| **調査リード (Research Lead)** | Gemini CLI | 大規模分析・最新情報調査・マルチモーダル・設計壁打ち |

## 協働の呼び出し方法

> 以下は各ツール間の呼び出し方法。協働の開始時やレビュー依頼時に使用する。

| 呼び出し元 | → Claude Code | → Codex CLI | → Gemini CLI |
|---|---|---|---|
| Claude Code | — | `/clasp-codex` スキル | `/clasp-gemini` スキル |
| Codex CLI | `claude -p "指示"` | — | `gemini -p "指示"` |
| Gemini CLI | `claude -p "指示"` | `codex -q "指示"` | — |

## フォールバック（CLI未インストール時）

協働先のCLIツールがインストールされていない場合、Claude Codeのモデル違いで代替する。

| 本来の協働先 | フォールバック | 理由 |
|---|---|---|
| Codex CLI（実装系） | Claude Code `sonnet` モデル | 高速・コード実装向き |
| Gemini CLI（調査系） | Claude Code `opus` モデル | 深い分析・推論向き |

協働開始前に `which codex` / `which gemini` 等で利用可能か確認し、未インストールならフォールバックを使うこと。

> 上記はClaude Code視点のフォールバック。Codex/Gemini視点のフォールバックは各固有ルールを参照。

## 協働ルール（全ツール必須）

1. **協働優先** — 他AIの得意分野の作業は協働で行う。単独で完結させない
2. **認識合わせ** — 非自明なタスクは開始前にパートナーの視点を得る。大きなタスクは認識合わせ自体も段階的に行う
3. **段階的タスク分解** — 大きなタスクは小さなステップに分解してから実行する。一度に大量の作業を渡さない。認識合わせも実行も、分解して段階的に進める（詳細はPhase 1, Phase 3のガイドラインを参照）
4. **報告してから実行** — 誰が何をするか、ユーザーに伝えてから開始
5. **チェックポイント実行** — 各ステップの完了後に検証を挟み、方向性のズレを早期に検出する
6. **相互レビュー必須** — 成果物は別AIがレビューしてから完了とする
7. **得意分野リード** — 各AIの得意分野を活かしてリード担当を決める（禁止ではなく推奨）
8. **柔軟な役割判断** — 役割はタスクごとに判断。固定テーブルではなく、状況に応じて決定
9. **簡易タスク閾値** — 閾値以下のタスクは直接実行可（省略理由を記録）
10. **再帰禁止** — A→Bで止まる（B→Cはしない）。Bが困ったらAに戻す
11. **ユーザー指名優先** — ユーザーの明示的指示は常に最優先
12. **独立タスク並列** — 依存のない複数タスクは並列実行
13. **失敗時の対処** — リトライ→フォールバック→ユーザー報告

## 協働リクエストテンプレート

### 認識合わせリクエスト

```
[認識合わせリクエスト]
ユーザーの依頼: "..."
自分の解釈: "..."
前提条件: [...]
懸念点: [...]

回答してほしいこと:
1. この解釈で合っている？修正点は？
2. 見落としているリスクや考慮事項は？
3. 推奨アプローチ（簡潔に）
```

### コード実装リクエスト（→ Codex）

- 何を実装/修正するか（具体的なファイルパスと変更内容）
- 制約条件（使用言語、フレームワーク、既存コードのスタイル）
- 期待する成果物（動作するコード、テスト結果）

### 調査・分析リクエスト（→ Gemini）

- 何を調査/分析するか（具体的な調査対象と質問）
- 期待する出力形式（比較表、要約、推奨案等）
- 必要な深さ（概要レベル / 詳細分析）

### 設計判断リクエスト（→ Claude）

- 判断が必要な背景・コンテキスト
- 選択肢がある場合はその一覧（分析結果・提案があれば添付）
- 期待する出力（方針決定、設計案、タスク分解、Git操作等）

## 得意分野と協働原則

各AIの得意分野を以下に定める。各個別ファイルの「得意分野プロファイル」はこの表に基づく。

| 得意領域 | リード担当 | 他ツールの役割 |
|---|---|---|
| コード実装・テスト・修正・CI/CD・コードレビュー | Codex CLI | レビュー・方針提示で協働 |
| 設計判断・意図解釈・対話・Git・MCP・タスク統括 | Claude Code | 提案・検証で協働 |
| 大規模分析・最新情報調査・マルチモーダル・設計壁打ち | Gemini CLI | 適用判断・実装で協働 |

## 標準協働ワークフロー

各エージェントは以下の4フェーズ協働サイクルに従ってタスクを処理する。

```
Phase 1: 認識合わせ → Phase 2: 方針策定 → Phase 3: 実行 → Phase 4: レビュー
```

### Phase 1: 認識合わせ

タスクを受けたら、まずパートナーAIと認識を合わせる。

**大きなタスクの場合は認識合わせ自体も段階的に行う**：
1. まず全体像レベルで「何をやるタスクか？」を合わせる
2. 次にスコープ・制約・前提条件を合わせる
3. 最後にアプローチ・分担の方向性を合わせる

一度に全部を合わせようとすると、認識合わせ自体の精度が落ちるため、大きな問いを小さな問いに分解して一つずつ確認する。

```
[認識合わせリクエスト]
ユーザーの依頼: "..."
自分の解釈: "..."
前提条件: [...]
懸念点: [...]

回答してほしいこと:
1. この解釈で合っている？修正点は？
2. 見落としているリスクや考慮事項は？
3. 推奨アプローチ（簡潔に）
```

- 実装系タスク → Codexと認識合わせ（実現可能性の観点）
- 調査系タスク → Geminiと認識合わせ（情報の観点）
- 設計系タスク → 両方と認識合わせ（必要に応じて）
- **簡易タスク閾値以下はスキップ可**（理由を記録）

### Phase 2: 方針策定

「誰が何をするか」をタスクごとに柔軟に決定。得意分野ベースの判断。

```
[ワークプラン]
タスク: "..."

役割分担:
- Step 1: [Agent] が [何を] する（理由: [得意分野]）
- Step 2: [Agent] が [何を] する（理由: [得意分野]）
- チェックポイント: [Agent] が [何を] 検証
```

### Phase 3: 実行（段階分解＋チェックポイント付き）

**大きなタスクは小さなステップに分解してから実行する**。一度に大量の作業を渡さない。

#### タスク分解のガイドライン

| タスク規模 | 分解の粒度 | チェックポイント |
|---|---|---|
| 小（1ファイル, <30行） | 分解不要、一括実行 | 完了時にレビューのみ |
| 中（2-5ファイル, 30-100行） | 2-3ステップに分割 | 各ステップ完了後に確認 |
| 大（5ファイル超, 100行超） | 機能単位で分割（5-10ステップ） | 2-3ステップごとに中間レビュー |

#### 分解の原則

1. **一度の呼び出しで渡すスコープを限定する** — 「全部やって」ではなく「この部分だけやって」
2. **各ステップの成果が検証可能であること** — 中間成果物が独立して評価できる粒度
3. **前のステップの結果を次のステップの入力にする** — フィードバックを反映してから次に進む
4. **認識のズレは早期に検出する** — 最初のステップの結果を見て方向性を確認してから残りに進む

#### 実行フロー

```
Step 1: 小さなスコープで実行を依頼
  ↓
結果受領 → 検証 → 方向性が合っているか確認
  ↓
（必要に応じて方針修正）
  ↓
Step 2: フィードバックを踏まえて次のスコープを実行
  ↓
... 繰り返し ...
  ↓
全ステップ完了 → Phase 4 レビューへ
```

### Phase 4: レビュー（必須）

成果物は必ず**別のAI**がレビューする。

```
[レビューリクエスト]
元のタスク: "..."
実行結果: [...]

レビュー観点:
1. 元の意図を満たしているか？
2. 品質上の問題はないか？
3. 見落としはないか？
```

> 各エージェントのカスタマイズ値は個別ファイル（CLAUDE.md, .codex/AGENTS.md, .gemini/GEMINI.md）のワークフローセクションを参照。

## 簡易タスク閾値

以下の条件を満たすタスクは、フル協働プロセスを省略して直接実行可能（省略理由を記録すること）：

- コード変更10行未満で仕様が明確
- 単一の事実確認・参照
- ルーティンのGit操作（コミット、ブランチ作成等）
- コード読み込み・理解のための参照

## 共通完了チェックリスト

タスクを完了報告する前に、以下を確認する:

- 認識合わせ: 非自明なタスクでパートナーと認識合わせを行ったか？（スキップ時は理由記録）
- 相互レビュー: 成果物を別AIにレビューしてもらったか？（閾値以下でスキップ時は記録）
- 得意分野の活用: パートナーの得意分野の作業を単独で完了していないか？
- チェックポイント: 大規模作業で中間チェックを設けたか？

> 各エージェント固有のチェック項目は個別ファイルの「タスク完了前チェックリスト」を参照。

## 並列/直列の判断基準

複数の協働が発生する場合、以下の基準で並列/直列を決定する:

- **並列**: タスク間に入出力の依存関係がない場合（例: 実装と調査を同時に進行）
- **直列**: タスクBがタスクAの出力を必要とする場合（例: 設計判断の後に実装）

> 具体的なパターン例は各個別ファイルの「並列協働の例」を参照。

## 協働パターンライブラリ

5つの再利用可能な協働パターン：

| パターン | 説明 | 使う場面 |
|---|---|---|
| **リード＋レビュー** | 一方がリード、他方がレビュー | 大半のタスク |
| **認識合わせ＋リード** | まず認識合わせ、その後リード | 曖昧・高リスクなタスク |
| **分割＋統合** | 独立部分を並列実行、結果を統合 | 独立したサブタスク |
| **提案＋検証** | 一方が提案、他方が検証・挑戦 | 設計判断 |
| **反復** | 複数ラウンドで段階的に品質向上 | 複雑な実装 |
