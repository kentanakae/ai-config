# AGENTS.md

## Multi-AI Delegation Framework (三位一体モデル)

このプロジェクトでは3つのAI CLIツールが自動的にタスクを委任し合う。

| 役割 | ツール | 担当領域 |
|---|---|---|
| **指揮者 (Conductor)** | Claude Code | 意図理解・設計判断・対話・タスク分解・統合・Git・MCP |
| **職人 (Craftsman)** | Codex CLI | コード実装・テスト・修正・定型作業・CI/CD・コードレビュー |
| **参謀 (Strategist)** | Gemini CLI | 大規模分析・最新情報調査・マルチモーダル・設計壁打ち（選択肢提示・比較分析。最終判断は指揮者） |

## 委任の呼び出し方法

| 委任元 | → Claude Code | → Codex CLI | → Gemini CLI |
|---|---|---|---|
| Claude Code | — | `/clasp-codex` スキル | `/clasp-gemini` スキル |
| Codex CLI | `claude -p "指示"` | — | `gemini -p "指示"` |
| Gemini CLI | `claude -p "指示"` | `codex -q "指示"` | — |

## フォールバック（CLI未インストール時）

委任先のCLIツールがインストールされていない場合、Claude Codeのモデル違いで代替する。

| 本来の委任先 | フォールバック | 理由 |
|---|---|---|
| Codex CLI（実装系） | Claude Code `sonnet` モデル | 高速・コード実装向き |
| Gemini CLI（調査系） | Claude Code `opus` モデル | 深い分析・推論向き |

委任前に `which codex` / `which gemini` 等で利用可能か確認し、未インストールならフォールバックを使うこと。

> 上記はClaude Code視点のフォールバック。Codex/Gemini視点のフォールバックは各固有ルールを参照。

## 共通ルール（全ツール必須）

1. **積極的委任** — 委任トリガーに該当する場合は**必ず**委任する。該当しない場合も、タスク開始前に「委任した方がより良い結果になるか」を常に検討すること（目安: 5ファイル以上の横断分析、3技術以上の比較、100行以上のコード生成は委任推奨）
2. **報告してから委任** — 委任前に「このタスクは○○に委任する」とユーザーに伝える
3. **再帰禁止** — 委任先から更に別ツールへの委任はしない（A→Bで止まる。B→Cはしない）
4. **ユーザー指名優先** — ユーザーが明示的に「自分でやれ」と指示した場合は委任しない
5. **進行中タスクは委任しない** — 既に作業を開始したタスクは自分で完了させる
6. **独立タスクは並列委任** — 複数ツールへの委任が発生し、タスク間に依存関係がなければ並列で呼び出す
7. **ルール優先順位** — 個別ルール（CLAUDE.md等）は共通ルール（本ファイル）より優先する。ただし共通ルール1〜6は常に適用される
8. **循環委任禁止** — 委任されたタスクを委任元に差し戻さない。対処できない場合はユーザーに報告する
9. **委任失敗時の対処** — 委任先がエラー・タイムアウトの場合: ①1回リトライ ②フォールバック先に委任 ③それでも失敗ならユーザーに報告
10. **結果は標準出力で返す** — 委任時の指示には「結果はファイルに書き出さず、標準出力（レスポンス）で返すこと」を必ず含める
11. **秘密情報の保護** — 委任指示にAPIキー・パスワード等の秘密情報を直接含めない。環境変数名で参照すること
12. **委任結果の確認** — 委任結果は受け取り後、目的に合致しているか確認してから使用する
13. **完了前の自己チェック** — タスク完了前に「委任すべき作業を自分でやっていないか」を確認し、違反があった場合は次回委任する旨をユーザーに報告する

## 委任指示テンプレート

### コード実装委任（→ Codex）の指示に含める内容
- 何を実装/修正するか（具体的なファイルパスと変更内容）
- 制約条件（使用言語、フレームワーク、既存コードのスタイル）
- 期待する成果物（動作するコード、テスト結果）

### 調査・分析委任（→ Gemini）の指示に含める内容
- 何を調査/分析するか（具体的な調査対象と質問）
- 期待する出力形式（比較表、要約、推奨案等）
- 必要な深さ（概要レベル / 詳細分析）

### 設計判断委任（→ Claude）の指示に含める内容
- 判断が必要な背景・コンテキスト
- 選択肢がある場合はその一覧（分析結果・提案があれば添付）
- 期待する出力（方針決定、設計案、タスク分解、Git操作等）

## 三位一体の基本原則

各エージェントの担当原則を以下に定める。各個別ファイルの「原則」セクションはこの表に基づく。

| 担当領域 | 担当ツール | 他ツールの行動 |
|---|---|---|
| コード実装・テスト・修正・CI/CD・コードレビュー | Codex CLI | 書かない。Codexに委任する |
| 設計判断・意図解釈・対話・Git・MCP・タスク統括 | Claude Code | 判断しない。Claudeに委任する |
| 大規模分析・最新情報調査・マルチモーダル・設計壁打ち | Gemini CLI | 検索しない。Geminiに委任する |

## 標準委任ワークフロー

各エージェントは以下のテンプレートに従ってタスクを処理する。{...} 部分は各個別ファイルで定義するカスタマイズ値である。

タスクを受けたら、**{自己実行の開始前}に**以下の手順で進める:

1. タスクの種類を判定する（{判定カテゴリ}）
2. 判定結果に基づき、**実行前に**委任先を決定する:
   - {委任先1の分岐条件} → **{委任先1} に委任**
   - {委任先2の分岐条件} → **{委任先2} に委任**
   - {自己実行の条件} → 自分で実行
3. 委任する場合:
   a. ユーザーに「このタスクは ○○ に委任します」と報告する
   b. {委任コマンド} で委任する
   c. 結果を受け取り、ユーザーに報告する
4. 自分で実行する場合: そのまま進める

> 各エージェントのカスタマイズ値は個別ファイル（CLAUDE.md, .codex/AGENTS.md, .gemini/GEMINI.md）のワークフローセクションを参照。

## 共通完了チェックリスト

タスクを完了報告する前に、以下を確認する:

- 他ツールの担当領域の作業を自分でやっていないか？（上記「三位一体の基本原則」参照）
- やっていた場合、次回は適切なツールに委任する旨をユーザーに報告する

> 各エージェント固有のチェック項目は個別ファイルの「タスク完了前チェックリスト」を参照。

## 並列/直列委任の判断基準

複数の委任が発生する場合、以下の基準で並列/直列を決定する:

- **並列**: タスク間に入出力の依存関係がない場合（例: 実装と調査を同時に進行）
- **直列**: タスクBがタスクAの出力を必要とする場合（例: 設計判断の後に実装）

> 具体的なパターン例は各個別ファイルの「並列委任の例」を参照。

## 委任整合性マッピング

各エージェント間の委任対象テーブルは双方向に整合している必要がある。以下は全テーブルの対応関係:

| 方向 | テーブルID | 項目数 | 定義ファイル |
|---|---|---|---|
| Claude → Codex | C→X1〜X9 | 9 | .claude/CLAUDE.md |
| Claude → Gemini | C→G1〜G6 | 6 | .claude/CLAUDE.md |
| Codex → Claude | X→C1〜C7 | 7 | .codex/AGENTS.md |
| Codex → Gemini | X→G1〜G5 | 5 | .codex/AGENTS.md |
| Gemini → Claude | G→C1〜C6 | 6 | .gemini/GEMINI.md |
| Gemini → Codex | G→X1〜X5 | 5 | .gemini/GEMINI.md |

### 更新ルール

- 委任対象テーブルを追加・変更・削除する場合は、対応する逆方向のテーブルも確認し、整合性を維持すること
- 例: C→X に新項目を追加した場合、X→C 側にも対応する受任項目があるか確認する
- 不整合を発見した場合はユーザーに報告し、修正方針を確認してから対応する
